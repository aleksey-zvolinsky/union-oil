[GLOBAL]
   TITLE = Движение сопутствующего товара по АЗС@Рух супутнього товару по АЗС
   MENU = Отчеты\Сопутствующий товар\Движение полный@Рух повний
   MENU_POSITION = 10
   VERSION = 2.1
   RAZM_SYMBOLS = NO
   PAGES_WIDTH = 1

[PANELS]
   DATEPANEL
   END

   ORGPANEL
   END


[DESCRIPTION]
   За период от :BeginDate до :EndDate@За період від :BeginDate до :EndDate
   Организация:: :org1.name@Організація:: :org1.name

[SQL]
Select azs_id,
       azs_inst,
       date_,
       NAME,
       id,
       US_GROUP_NAME,
       npname,
       codavias,
       RestOnBegin,
       sum(RestOnEnd1) over(partition by azs_id, id, npname order by date_) - Prih_Count + Rash_Count as RestBeginOnDate,
       Prih_Count,
       Prih_Sum,
       Rash_Count,
       price,
       Rash_Money,
       sum(RestOnEnd1) over(partition by azs_id, id, npname order by date_) as RestOnEnd
  from (select X.azs_id,
               X.azs_inst,
               X.date_,
               X.NAME,
               X.id,
               X.npname,
               X.US_GROUP_NAME,
               X.codavias,
               sum(nvl(X.restonbegin, 0)) as RestOnBegin,
               sum(nvl(X.prih_count, 0)) as Prih_Count,
               sum(nvl(X.prih_sum, 0)) as Prih_Sum,
               sum(nvl(X.rash_litr, 0)) as Rash_Count,
               max(X.price) as Price,
               sum(nvl(X.rash_money, 0)) as Rash_Money,
               sum(nvl(X.restonbegin, 0) + nvl(X.prih_count, 0) -
                   nvl(X.rash_litr, 0)) as RestOnEnd1
          from (select /*+ORDERED INDEX(dr I_DR_DATA) INDEX(drep IDX$REP_DATE_TRUNC)*/
                 drep.azs_id as azs_id,
                 drep.inst as azs_inst,
                 to_date(trunc(drep.rep_date)) as date_,
                 org.name,
                 npt.id,
                 npt.name as npname,
                 npt.us_group_name,
                 npt.codavias,
                 dr.pr_litr as PRIH_COUNT,
                 dr.pr_litr * dr.s_price as PRIH_SUM,
                 0 as RestOnBegin,
                 nvl(dr.out_nal_litr, 0) + nvl(sr.litr, 0) as rash_litr,
                 dr.s_price as price,
                 nvl(dr.out_nal_money, 0) + nvl(sr.amount, 0) as rash_money
                  from oil_daily_rep drep,
                       oil_dr_data   dr,
                       oil_srother   sr,
                       oil_rashod    r,
                       oil_part      p,
                       v_oil_np_type npt,
                       v_oil_azs     org
                 where dr.state = 'Y'
                   and drep.state = 'Y'
                   and r.state = 'Y'
                   and sr.state(+) = 'Y'
                      
                   and dr.oper_type in (0, 1)
                      
                   and dr.pr_ud_weig = 1
                      
                   and dr.ttn_id = r.id
                   and dr.ttn_inst = r.inst
                      
                   and dr.rep_id = drep.id
                   and dr.rep_inst = drep.inst
                      
                   and r.part_id = p.id
                   and r.part_inst = p.inst
                      
                   and sr.srep_id(+) = dr.id
                   and sr.srep_inst(+) = dr.inst
                      
                   and p.np_type = npt.id
                   and p.state = 'Y'
                      
                   and org.obl_id = :org1.id
                   and drep.inst = :org1.id
                   and drep.azs_id = org.id
                   and drep.azs_inst = org.inst
                      
                   and trunc(drep.rep_date) between :BeginDate and :EndDate
                
                union all
                
                select /*+ORDERED INDEX(drep IDX_OIL_DAYLY_REP_AZS) INDEX(dr I_DR_DATA)*/
                 drep.azs_id as azs_id,
                 drep.inst as azs_inst,
                 :BeginDate as date_,
                 org.NAME as name,
                 npt.id,
                 npt.name as npname,
                 npt.us_group_name,
                 npt.codavias,
                 0 as PRIH_COUNT,
                 0 as PRIH_SUM,
                 sum((nvl(dr.pr_count, 0) - nvl(dr.out_nal_count, 0) -
                     nvl(dr.out_ved_count, 0) - nvl(dr.out_talon_count, 0) -
                     nvl(dr.out_sn_count, 0) - nvl(dr.out_count, 0))) as RestOnBegin,
                 0 as rash_litr,
                 0 as price,
                 0 as rash_money
                  from v_oil_azs     org,
                       oil_daily_rep drep,
                       oil_dr_data   dr,
                       oil_rashod    r,
                       oil_part      p,
                       v_oil_np_type npt
                 where drep.state = 'Y'
                   and dr.state = 'Y'
                   and r.state = 'Y'
                      
                   and drep.id = dr.rep_id
                   and drep.inst = dr.rep_inst
                      
                   and dr.ttn_id = r.id
                   and dr.ttn_inst = r.inst
                   and dr.pr_ud_weig = 1
                   and dr.oper_type in (0, 1)
                      
                   and r.part_id = p.id
                   and r.part_inst = p.inst
                      
                   and p.np_type = npt.id
                   and p.state = 'Y'
                      
                   and org.obl_id = :org1.id
                   and drep.inst = :org1.id
                   and drep.azs_id = org.id
                   and drep.azs_inst = org.inst
                      
                   and drep.rep_date < :BeginDate
                 group by drep.azs_id,
                          drep.inst,
                          org.NAME,
                          npt.id,
                          npt.name,
                          npt.us_group_name,
                          npt.codavias,
                          dr.pr_litr,
                          dr.pr_count,
                          dr.s_price) X
         group by azs_id,
                  AZS_INST,
                  date_,
                  NAME,
                  id,
                  npname,
                  us_group_name,
                  codavias) Y
 
[FIELDS]
   DEFAULT WIDTH = 12

   NAME = date_
   CAPTION = ДАТА
   Format = dd/mm/yyyy
   WIDTH = 15

   NAME = name
   CAPTION = АЗС

   NAME = id
   CAPTION = Код OIL
   WIDTH = 8

   NAME = codavias
   CAPTION = Код ННБ
   WIDTH = 8

   NAME = us_group_name
   CAPTION = Группа соп.товара@Група суп.товара
   WIDTH = 20

   NAME = npname
   CAPTION = Наименование товара@Назва товара
   WIDTH = 20

   DEFAULT FORMAT = 0.00
   
   NAME = RestOnBegin
   CAPTION = Остаток на начало! периода, к-во@Залишок на початок! періода, к-сть
   FORMAT = 0

   NAME = RestBeginOnDate
   CAPTION = Остаток на начало! дня, к-во@Залишок на початок! дня, к-сть
   FORMAT = 0

   NAME = Prih_Count
   CAPTION = ПРИХОД СО СКЛАДА!к-во@Прихід зі склада!к-сть
   FORMAT = 0
   TOSUM = TRUE

   NAME = Prih_Sum
   CAPTION = ПРИХОД СО СКЛАДА!сумма@Прихід зі склада!сума
   TOSUM = TRUE

   NAME = Rash_Count
   CAPTION = РАСХОД!к-во@Витрата!к-сть
   FORMAT = 0
   TOSUM = TRUE

   NAME = price
   CAPTION = Цена!грн.@Ціна!грн.

   NAME = Rash_Money
   CAPTION = РАСХОД!сумма всего@Витрата!сума всього
   TOSUM = TRUE
   
   NAME = RestOnEnd
   CAPTION = Остаток на конец!к-во@Залишок на кінець!к-сть
   FORMAT = 0

[TYPES]
   
   CAPTION = Дата - АЗС
   ITOGI = date_ ,name

   CAPTION = Дата - АЗС - Товар
   ITOGI = date_ ,name,id